cmake_minimum_required(VERSION 3.20)
project(MipsSim LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# ç‚ºäº†åŠ é€Ÿç·¨è­¯ï¼Œå…ˆåªç·¨è­¯æ ¸å¿ƒåŠŸèƒ½
add_subdirectory(src)

# æ·»åŠ  CLI æ¨¡å¡Š
add_subdirectory(cli)

# åªåœ¨éœ€è¦æ™‚ç·¨è­¯æ¸¬è©¦
option(BUILD_TESTING "Build tests" ON)
if(BUILD_TESTING)
    add_subdirectory(tests)
endif()

# Qt GUI æš«æ™‚é—œé–‰ä»¥æ¸›å°‘ç·¨è­¯æ™‚é–“
option(ENABLE_QT "Build Qt GUI" OFF)
if (ENABLE_QT)
  find_package(Qt6 COMPONENTS Widgets REQUIRED)
  add_executable(mips_gui src/gui/main_window.cpp)
  target_link_libraries(mips_gui PRIVATE Qt6::Widgets mips_core)
  target_compile_features(mips_gui PRIVATE cxx_std_20)
endif()

# ===== ä»£ç¢¼æ ¼å¼åŒ–æ”¯æŒ =====
# å°‹æ‰¾ clang-format
find_program(CLANG_FORMAT_EXECUTABLE
    NAMES clang-format clang-format-14 clang-format-13 clang-format-12
    DOC "Path to clang-format executable"
)

if(CLANG_FORMAT_EXECUTABLE)
    message(STATUS "ğŸ¨ æ‰¾åˆ° clang-format: ${CLANG_FORMAT_EXECUTABLE}")
    
    # æ”¶é›†æ‰€æœ‰ C++ æºæ–‡ä»¶
    file(GLOB_RECURSE ALL_CXX_SOURCE_FILES
        ${CMAKE_SOURCE_DIR}/src/*.cpp
        ${CMAKE_SOURCE_DIR}/src/*.h
        ${CMAKE_SOURCE_DIR}/tests/*.cpp
        ${CMAKE_SOURCE_DIR}/*.cpp
        ${CMAKE_SOURCE_DIR}/*.hpp
    )
    
    # æ’é™¤ç¬¬ä¸‰æ–¹ä»£ç¢¼å’Œç”Ÿæˆçš„æª”æ¡ˆ
    list(FILTER ALL_CXX_SOURCE_FILES EXCLUDE REGEX ".*build.*")
    list(FILTER ALL_CXX_SOURCE_FILES EXCLUDE REGEX ".*_deps.*")
    list(FILTER ALL_CXX_SOURCE_FILES EXCLUDE REGEX ".*CMakeFiles.*")
    
    # æ·»åŠ æ ¼å¼åŒ–ç›®æ¨™
    add_custom_target(format
        COMMAND ${CLANG_FORMAT_EXECUTABLE} -i -style=file ${ALL_CXX_SOURCE_FILES}
        COMMENT "ğŸ¨ æ­£åœ¨æ ¼å¼åŒ–ä»£ç¢¼..."
        VERBATIM
    )
    
    # æ·»åŠ æ ¼å¼æª¢æŸ¥ç›®æ¨™
    add_custom_target(format-check
        COMMAND ${CLANG_FORMAT_EXECUTABLE} --dry-run --Werror -style=file ${ALL_CXX_SOURCE_FILES}
        COMMENT "ğŸ” æª¢æŸ¥ä»£ç¢¼æ ¼å¼..."
        VERBATIM
    )
    
    message(STATUS "ğŸ’¡ ä½¿ç”¨æ–¹å¼:")
    message(STATUS "   cmake --build . --target format      # æ ¼å¼åŒ–æ‰€æœ‰ä»£ç¢¼")
    message(STATUS "   cmake --build . --target format-check # æª¢æŸ¥ä»£ç¢¼æ ¼å¼")
    
else()
    message(STATUS "âš ï¸  æœªæ‰¾åˆ° clang-formatï¼Œä»£ç¢¼æ ¼å¼åŒ–åŠŸèƒ½ä¸å¯ç”¨")
    message(STATUS "   å®‰è£æ–¹å¼: choco install llvm (Windows)")
    message(STATUS "           sudo apt install clang-format (Linux)")
    message(STATUS "           brew install clang-format (macOS)")
endif()
